# Chapter 3. 머신러닝 파이프라인

<aside>
💡 발표 준비 …… 막막하구만 ….. ㅠㅠ
뭔가 파이프라인에 대해서는 처음 배우는 것 같은데 모르는 용어가 많아서 조금 당황스럽기도 하다. 이거 다… 배우게 되겠지?… 그건 또 그거대로 곤란하네 ;;

</aside>

---

## 👻 머신러닝 파이프라인이란 무엇인가

모델 훈련 = 프로세스의 일부분일 뿐 … 데이터 정리/변환/준비하는 데 시간 ⬆️ 

`**파이프라인( pipeline )`** = 한 데이터 처리 단계의 출력이 다음 단계의 입력으로 이어지는 형태로 연결된 구조 → 그러나 실제로 머신러닝 파이프라인은 단방향이 아닌 주기적이고 반복적일 수 있음

적절한 수집 메커니즘 선택, 데이터 정리, 특성 공학 등… 파이프라인의 초기 단계 매우 중요 ! 

또한 모델 성능 측정 및 모니터링, 모델을 재훈련하는 시기와 방법에 따라서도 결과가 크게 달라짐

→ 파이프라인 구현을 위해 다양한 머신러닝 솔루션 존재 … ( 파이썬, 하둡, R, 스파크, AWS, 데이터 브릭스 등 )

### 머신러닝 파이프라인의 주요 단계

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b2e2be82-896d-4854-9e1f-03870a8c3f01/Untitled.png)

1. `문제 정의`
2. `데이터 수집`
3. `데이터 준비`
    - 결측치 대치 및 중복 레코드 제거
    - 값 정규화 ( 공통으로 사용하기 위해 데이터 세트의 숫자 값 변경 )
    - 다른 유형의 정리나 매핑 수행
    - 완전한 특성 추출
    - 상관 특성 제거
    - 특성 공학 수행
4. `데이터 분리` → train / varidation / test
5. `모델 학습` 
6. `후보 모델 평가` → 검증용 데이터와 테스트용 데이터 사용해 성능 측정
7. `모델 배포` → 모델 선택 후 제품으로 배포
8. `성능 모니터링` → 재교육 및 보정을 통해 개선 … 새 데이터 사용 ! 

---

## 🦨 문제 정의

**파이프라인 설정 시 가장 중요한 단계, 올바른 질문을 하고 틀을 잡는 것이 가장 중요 !** 

예시 ) 채무 불이행 예측 결정 파이프라인을 위한 질문 → 돈을 얼마나, 언제 받는가

<aside>
✨ 대출이 결정되면, 이 대출에 대해 채무불이행이 발생할지 혹은 정상적으로 대출금을 회수할 수 있을지를 결정할 수 있을까?

</aside>

→ 첫 달 채무불이행 / 20년의 대출 채무불이행 구분 X → 수익성 달라짐

<aside>
✨ 채무불이행은 언제인가?

</aside>

→ 차용인이 지불금을 보내는 방식에 따라 달라질 수 있음 ( 아예 보내지 X, 산발적으로 보냄 등 )

<aside>
✨ 주어진 대출에 대해 돈을 얼마나 받게 되는가

</aside>

→ 언제 지불하는가에 따라 이자, 즉 수익이 달라짐

<aside>
✨ 대출 이자는 얼마인가?

</aside>

→ 기본 채무불이행률을 결정 시 법률에 따라 사용할 수 없는 입력 변수 ( 성별, 인종 등 ) 존재

<aside>
✨ 허용되지 않는 입력 특성을 사용하지 않고 주어진 대출에 대한 이익은 무엇일까?

</aside>

→ **문제에 대한 진술은 지속적으로 수정, 필요에 따라 조정**

---

## 😣 데이터 수집

**질문을 답하는 데 도움이 되는 원시 데이터 수집** → 문제에 따라 관련 데이터 세트를 얻기 어려울 수 있음

- `어떤 데이터 공급자 또는 공급 업체`를 사용해야 하는가? → 신뢰성
- `데이터를 어떻게 수집`하는가? ( 하둡, 임팔라, 스파크, 파이썬 … )
- 수집한 데이터를 `파일`로 저장해야 하는가, 아니면 `데이터베이스`에 저장해야 하는가?
- `어떤 유형의 데이터베이스`를 사용하는가? ( RDBMS, NoSQL … )
- 데이터를 `저장해야 하는가`? → 실시간 피드가 있다면 저장 필요 X거나 효율 X일 수 있음
- `입력 형식`은 무엇인가? ( 파케이, Json, CSV … )
    
    → 결정하지 못할수도 있고, 어떻게 변환해야 할지도 정해야 함 …
    
    → 소스 종류가 여러 개라면 통합, 병합, 결합 필요 
    

### 도메인 지식

관련 입력 변수를 선택하고 성공적인 모델을 설정하려면 데이터 과학자에게 도메인 지식이 필요함

→ 사용 가능한 여러 특성 중 선택해야 하는데, 단독으로는 의미가 없어 결합해야 할 수도 있음

| 특성 이름 | 특성에 관한 설명 | 유용한 이유 |
| --- | --- | --- |
| 연체된 계좌 | 연체된 계정 수 | 청구서 지불 X → 새로운 대출금도 지불 X |
| 현재 잔고 | 모든 계좌의 평균 잔고 | 단독으로는 가치 X, 상대적일 때 가치 O |
| 이자율 | 대출 금리  | 대출 금리가 높을수록 상환하기 어려움 |

결합해서 만든 새로운 변수 ( 특성 공학의 예시 )

| 특성 이름 | 특성에 관한 설명 | 유용한 이유 |
| --- | --- | --- |
| 신용도 활용 | 모든 거래에 대한 신용 한도 잔액, 신용 한도 대비 현재 잔액 | 비율이 높으면 차용인이 ‘최댓값’에 도달했으며 새 신용을 얻는 데 문제 O |
| 소득 대비 부채 | 모기지와 해당 대출을 제외한 총 채무에 대한 월 지불액 / 차용인이 자체 보고한 월 소득 | 소득 대비 부채 비율이 낮으면 채무 상환할 자원이 충분 → 문제 X  |

---

## 😏 데이터 준비

원시 데이터 → 데이터 정리, 필터링, 집계, 증강, 통합, 보관 필요

- **`인기있는 클라우드 스택`**
    - 애저 ML 서비스, 아마존 세이지 메이커, 구글 클라우드 ML 엔진, SAS, 래피드 마이너, KNIME
- **`데이터 저장소`**
    - 아파치 하둡 분산 파일 시스템 ( HDFS ), 아파치 HBase, 아파치 카산드라
    - 아마존 S3, 애저 블롭 스토리지
    
    → 머신러닝을 위한 데이터를 DB 내부에서 처리할 수도 있음 
    
- **`실시간 데이터 처리 솔루션`** → 내결함성, 확장 가능, 지연 시간 짧음
    - 아파치 카프카, 애저 이벤트 허브, 아마존 키네시스

### 결측치( MISSING VALUE ) 대치

빈 값, 0, N/A 등 … 처리 방법

1. **`아무것도 하지 않음`**
    
    → XG부스트 등의 알고리즘은 결측치 작업 수행하지 않아도 됨 
    
2. **`중앙값 사용 대치`**
    
    → 상관관계 고려 x, 정확도가 높지 않음, 계산이 쉬우며 소규모에 적합
    
3. **`최빈값, 상수 대치`** 
    
    → 변수에 의해 작동하는 장점, 상관 관계 고려 x … 편향 도입 가능
    

### 중복 레코드 또는 값

값이 정말 동일하다면 문제 x … 동일하게 식별해야 하지만 약간의 차이가 있는 경우는 문제 ! 

→ 정확하게 일치하는 값을 찾는 대신 데이터 유사성을 평가하는 `fuzzy matching` 사용 … 

### 특성 스케일링

데이터 세트에 포함되는 특성은 크기가 다를 때가 많음 → 정확성에 나쁜 영향을 미치기도 함

→ `크기 조정( 최소-최대 정규화 )`, `평균 정규화`, `표준화( Z-점수 정규화 )`, `단위 길이로 스케일링`

### 일관되지 않은 값

약어, 주소처럼 일관되지 않은 형태로 데이터가 들어올 수 있음 → 인간은 판단 가능 …

일관되지 않은 날짜 형식의 경우에도 표준화 필요함!

1. `규칙 기반 접근 방식`
    
    데이터의 변동성이 적고 빠르게 변하지 않을 때 잘 작동
    
2. `예제 기반 접근 방식`
    
    머신러닝 사용… 빠르게 변하는 경우 더 유용함
    

→ 두 가지 다 사용하는 `하이브리드 접근 방식` 사용도 가능 

---

## 🦋 데이터 분리

모델 훈련을 위해 데이터를 `훈련 / 테스트` 혹은 `훈련 / 검증 / 테스트`의 하위 집합으로 나누어줌 

→ 훈련 데이터를 사용해 모델을 훈련, 테스트 데이터를 사용해 예측 진행 

---

## 🦀 모델 훈련

일련의 모델에 대한 훈련 및 테스트, 성능 평가 → 반복적인 프로세스로 최적화된 모델 찾기 

### 후보 모델 평가 및 선택

항상 최고의 성능을 내는 모델을 선택하지는 X → 문제에 가장 적합한 모델을 선택 ! 

훈련 데이터에 잘 작동해도 overfitting 되었을 수도 있음 

### 모델 배포

모델은 일반적으로 API를 통해 사용되며, 의사 결정 프레임워크에 포함됨 → 비지니스 요구사항에 따라 결정

- `실시간`으로 예측을 수행할 수 있어야 하는가 ( 그렇다면 단위는 ? )
- 모델을 얼마나 자주 `업데이트` 해야 하는가
- `볼륨이나 트래픽 양`은 어느 정도로 예상되는가
- `데이터 세트의 크기`는 어느 정도인가
- 따라야 할 `규정, 정책 및 기타 제약`이 있는가

**🐬 네 가지 배포 아키텍처** 

|  | RESTful API | 공유된 DB | 스트리밍 | 모바일 앱 |
| --- | --- | --- | --- | --- |
| 학습 모델 | 배치 | 배치 | 스트리밍 | 스트리밍 |
| 예측 방법 | 실시간 | 배치 | 스트리밍 | 실시간 |
| 결과 전송 방법 | RESTful API | 공유 DB | 메시지 큐 스트리밍 | 모바일 내부 API |
| 예측 지연 | 낮음 | 높음 | 매우 낮음 | 낮음 |
| 시스템 유지성 | 보통 | 쉬움 | 어려움 | 보통 |

→ 세부 사항 선택 시에는 더 많은 고려 사항 … ( 모듈화된 마이크로서비스 or 모놀리식 … )

🐌 **아키텍처 선택 원칙**

- `재현성` : 모델 입/출력, 메타데이터를 모두 저장 → 최신 버전 관리 사용 여부
- `자동화` : 가능한 한 빨리 학습 및 모델 게시를 자동화
- `확장성` : 정기적으로 업데이트해야 하는 경우 처음부터 계획
- `모듈화` : 작업 코드를 모듈화 → 각 모듈을 제어하는 환경 전반에서 파이프라인 재현 여부 확인
- `테스트` : 파이프라인을 테스트하는 데에 충분한 시간 할당 … TDD와 BDD 살펴보기

### 성능 모니터링

모델이 배포된 후 만족스럽게 작동하는지 자세히 모니터링 필요 ! → 적절한 보정을 통해 점진적 개선 …

새로운 데이터를 수집, 다양한 관점에서 주의를 기울여야 함 

🐧 **모니터링 지표** 

1. **`모델 성능`** : 모델 실행 속도가 아닌 예측의 정확성
    
    Drift( 모델과 관련이 없는 데이터거나 유용한 입력이 아닐 때 발생 )를 살펴보기
    
    → 데이터는 변경돼 예측 가치를 잃을 수 있으므로 데이터 포인트를 확인해야 함 
    
2. **`운영 성능`**
    
    리소스 소비 모니터링 ( CPU, 메모리, 디스크, 네트워크 I/O 트래픽, 지연 시간, 처리량 … )
    
3. **`총 소유 비용( TCC )`**
    
    회사는 비용 대비 모델에서 얻는 이점에도 초점을 맞춰야 함 → 비용을 낮추거나 새로운 기회 활용
    
    파이프라인이 충분한 가치를 제공하는지 → 변경 or 종료 여부 결정
    
4. **`서비스 성능`**
    
    이전에 합의한 Service Level Agreement ( SLA )를 설정, 모니터링 및 충족